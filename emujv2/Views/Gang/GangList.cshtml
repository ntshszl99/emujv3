@{
    ViewBag.Title = "GangList";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="app-content main-content">
    <div class="side-app">
        <div class="container-fluid main-container">

            <!--Page header-->
            <div class="page-header">
                <div class="page-leftheader">
                    <h4 class="page-title">Gang List</h4>
                </div>
            </div>
            <!--End Page header-->

            <div class="" id="contentAdmin">
                <div class="card">
                    <div class="card-body">
                        <div class="mb-3 m-0">
                            <h6><i>View the gang list by selecting Kmuj or Section</i></h6>
                        </div><div class="row">
                            <div class="col-4">
                                <label class="mt-3 form-label">KMUJ</label>
                                <select id="kmuj" class="form-control form-select select2">
                                    <option value="-0">Select KMUJ</option>
                                </select>
                            </div>
                            <div class="col-4">
                                <label class="mt-3 form-label">Section</label>
                                <select id="section" class="form-control form-select select2">
                                    <option value="-0">Select Section</option>
                                </select>
                            </div>
                            <div class="col-4">
                                <label class="mt-3 form-label">Gang</label>
                                <select id="gangAdmin" class="form-control form-select select2">
                                    <option value="-0">Select Gang</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <div class="col-lg-12">
                                    <div class="table-responsive table-lg">
                                        <table id="tableAdmin" class="table table-striped table-bordered text-nowrap">
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <div class="" id="contentNormal">
                <div class="card">
                    <div class="card-body">
                        <div class="mb-3 m-0">
                            <div class="row">
                                <div class="col-3">
                                    <label class="mt-3 form-label">Gang</label>
                                    <select id="gangNormal" class="form-control form-select select2">
                                        <option value="-0">Select Gang</option>
                                    </select>
                                </div>
                                <div class="card-body">
                                    <div class="col-lg-12">
                                        <div class="table-responsive table-lg">
                                            <table id="tableNormal" class="table card-table table-vcenter text-nowrap border">
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="" id="contentOthers">
                <div class="card">
                    <div class="card-body">
                        <div class="mb-3 m-0">
                            <div class="row">
                                <div class="card-body">
                                    <h4 class="text-muted">Alert</h4>
                                    <p class="text-muted">Sorry, no data found.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--Modal User Details-->
            <div class="modal fade" id="modalDetails" tabindex="-1" aria-labelledby="modalUpdateLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-body text-center p-4">
                            <i class="fe fe-check-circle text-success lh-1 mg-t-20 d-inline-block" style="font-size: 5em;"></i>
                            <h3 class="text-success">Confirm Action</h3>
                            <p class="mg-b-20 mg-x-20">Are you sure to update this data?</p>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="form-label">Staff ID</div>
                                        <input readonly id="staffID" type="text" class="form-control text-center bg-transparent border-0">
                                    </div>
                                    <div class="col-12">
                                        <div class="mt-5 form-label">Staff Name</div>
                                        <input readonly id="staffname" type="text" class="form-control text-center bg-transparent border-0">
                                    </div>
                                    <div class="col-12">
                                        <div class="mt-5 form-label">Department</div>
                                        <input readonly id="dept" type="text" class="form-control text-center bg-transparent border-0">
                                    </div>
                                    <div class="col-12">
                                        <div class="mt-5 form-label">Designation</div>
                                        <input readonly id="position" type="text" class="form-control text-center bg-transparent border-0">
                                    </div>
                                    <div class="mb-5"></div>
                                    <div class="card-body bg-success-transparent-2">
                                        <div class="mb-0 m-0">
                                            <div class="row">
                                                <div class="col-12">
                                                    <div class="form-label">Update Status</div>
                                                    <select id="cuti" class="form-control form-select select2" required="required">
                                                        <option value="-0">.: Select Reason :.</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <button id="submitUpdate" class="btn btn-success mb-5" type="button">Update</button>
                            <button class="btn btn-light mb-5" data-bs-dismiss="modal" aria-label="Close" type="button">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!--Modal Delete Data-->
            <div class="modal fade" id="modalDelete" tabindex="-1" aria-labelledby="modalDeleteLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-body text-center p-4">
                            <h3 class="mt-5 text-danger">Warning! Are you sure? </h3>
                            <p class="mg-b-20 mg-x-20">You may not be able to recover this data.</p>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="form-label">Staff ID</div>
                                        <input readonly id="staffID2" type="text" class="form-control text-center bg-transparent border-0">
                                    </div>
                                    <div class="col-12">
                                        <div class="mt-5 form-label">Staff Name</div>
                                        <input readonly id="staffname2" type="text" class="form-control text-center bg-transparent border-0">
                                    </div>
                                    <div class="col-12">
                                        <div class="mt-5 form-label">Department</div>
                                        <input readonly id="dept2" type="text" class="form-control text-center bg-transparent border-0">
                                    </div>
                                    <div class="col-12">
                                        <div class="mt-5 form-label">Designation</div>
                                        <input readonly id="position2" type="text" class="form-control text-center bg-transparent border-0">
                                    </div>
                                    <div class="mb-5"></div>
                                </div>
                            </div>

                            <button id="submitDelete" class="btn btn-danger mb-5" type="button">Delete</button>
                            <button class="btn btn-light mb-5" data-bs-dismiss="modal" aria-label="Close" type="button">Cancel</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section scripts{
    <script src="~/assets/plugins/select2/select2.min.js"></script>
    <script src="~/assets/scripts/semua.js"></script>
    <script src="~/assets/scripts/dashboard.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {
            checkSess();
            listSection();
            listKMUJ();
            listGang();
            listCuti();
            listReportsAdmin();
            listReportsNormal();

            if (localStorage.getItem("lvlI") === "1") {
                $("#contentAdmin").show();
                $("#contentNormal").hide();
                $("#contentOthers").hide();

                $("#gangAdmin, #kmuj, #section").change(function () {
                    checkStore();

                    gng = $("#gangAdmin option:selected").text();
                    localStorage.setItem("selGng", gng, this.value);

                    kmj = $("#kmuj option:selected").text();
                    localStorage.setItem("selKmj", kmj, this.value);

                    scn = $("#section option:selected").text();
                    localStorage.setItem("selScn", scn, this.value);

                    if ($("#kmuj option:selected").val() != '-0' && $("#gangAdmin option:selected").val() != '-0') {
                        salertSave('List Gang : ' + scn + ' of ' + gng + ' ');
                    }
                    else if ($("#section option:selected").val() != '-0' && $("#gangAdmin option:selected").val() != '-0') {
                        salertSave('List Gang : ' + kmj + ' of ' + gng + ' ');
                    }
                    else if ($("#kmuj option:selected").val() != '-0' && $("#section option:selected").val() != '-0' && $("#gangAdmin option:selected").val() != '-0') {
                        salertSave('List Gang : ' + kmj + ' and ' + scn + ' of ' + gng + ' ');
                    }
                    listReportsAdmin(localStorage.getItem("selKmj", this.value),
                        localStorage.getItem("selScn", this.value),
                        localStorage.getItem("selGng", this.value));
                });
            }
            else if (localStorage.getItem("lvlI") === "2" ||
                localStorage.getItem("lvlI") === "3" ||
                localStorage.getItem("lvlI") === "4" ||
                localStorage.getItem("lvlI") === "5" ||
                localStorage.getItem("lvlI") === "6") {

                scn = localStorage.getItem("scn");
                localStorage.setItem("selScn", scn, this.value);
                console.log(scn);

                if (scn == 'null' || scn == ' ') {
                    $("#contentOthers").show();
                    $("#contentNormal").hide();
                    $("#contentAdmin").hide();
                }
                else {
                    $("#contentNormal").show();
                    $("#contentOthers").hide();
                    $("#contentAdmin").hide();

                    $("#gangNormal").on('change', function () {
                        checkStore();

                        gng = $("#gangNormal option:selected").text();
                        localStorage.setItem("selGng", gng, this.value);

                        scn = localStorage.getItem("scn");
                        localStorage.setItem("selScn", scn, this.value);

                        listReportsNormal(localStorage.getItem("selScn", this.value),
                            localStorage.getItem("selGng", this.value));
                    });
                }
            }

        });

        //modal user details & delete user
        $('#modalDetails, #modalDelete').on('show.bs.modal', function (e) {
            var ids = $(e.relatedTarget).data('id');
            $(this).data('id', ids);
            console.log('read ' + ids);
            stfDetails(ids);
        });

        //button submit update user
        $("#submitUpdate").click(function () {
            var ids = $('#modalDetails').data('id');
            console.log('read ' + ids);
            updateUser(ids);
        });

        //modal delete user
        $('#submitDelete').click(function () {
            var ids = $('#modalDelete').data('id');
            console.log('read ' + ids);
            stfDelete(ids);
        });

        function stfDetails(ids) {
            var staffID = $(".staffID" + ids).html();
            $.ajax({
                url: linkDepan + "GetGangDetails?StaffId=" + ids,
                type: 'GET',
                dataType: 'json',
                data: {},
                beforeSend: function (request) {
                    request.setRequestHeader("Token", localStorage.getItem('main'));
                },
                success: function (data) {
                    $('#staffID, #staffID2').val(data[0].staff_no);
                    $('#staffname, #staffname2').val(data[0].staff_name);
                    $('#dept, #dept2').val(data[0].section_id);
                    $('#position, #position2').val(data[0].position);
                },
                error: function (xhr) {
                    swarning();
                },
                complete: function () {
                }
            });
        }

        //update hal user
        function updateUser(ids) {
            var data = {
                Userid: ids,
                StatusCuti: $('#cuti').val(),
            };

            console.log("Updating user:", ids);
            console.log("Status Cuti:", $("#cuti option:selected").val());

            $.ajax({
                url: linkDepan + "UpdateGangDetails",
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(data),
                beforeSend: function (request) {
                    request.setRequestHeader("Token", localStorage.getItem('main'));
                },
                success: function (response) {
                    var data;
                    try {
                        data = JSON.parse(response);
                    } catch (error) {
                        console.error("Error parsing JSON:", error);
                        swarning();
                        return;
                    }
                    if (data && data.status === "00") {
                        $('#modalDetails').modal('hide');
                        swal.fire('Success!', 'User details have been updated.', 'success');

                    } else {
                        $('#modalDetails').modal('hide');
                        swarning();
                    }
                    if (localStorage.getItem("lvlI") === "1") {
                        listReportsAdmin(localStorage.getItem("selKmj", this.value),
                            localStorage.getItem("selScn", this.value),
                            localStorage.getItem("selGng", this.value));

                    } else if (["2", "3", "4", "5", "6"].includes(localStorage.getItem("lvlI"))) {
                        var scn = localStorage.getItem("scn");
                        localStorage.setItem("selScn", scn);
                        console.log(scn);

                        if (scn == 'null' || scn == ' ') {
                            $("#contentOthers").show();
                            $("#contentNormal").hide();
                            $("#contentAdmin").hide();
                        } else {
                            $("#contentNormal").show();
                            $("#contentOthers").hide();
                            $("#contentAdmin").hide();

                            listReportsNormal(localStorage.getItem("selScn"),
                                localStorage.getItem("selGng"));
                        }
                    }
                },
            });
        }

        function stfDelete(ids) {
            var data = {
                Userid: ids,
            };
            $.ajax({
                url: linkDepan + "DeleteGangDetails?StaffId=" + ids,
                type: 'DELETE',
                contentType: 'application/json',
                data: JSON.stringify(data),
                beforeSend: function (request) {
                    request.setRequestHeader("Token", localStorage.getItem('main'));
                },
                success: function (response) {
                    var data;
                    try {
                        data = JSON.parse(response);
                    } catch (error) {
                        console.error("Error parsing JSON:", error);
                        swarning();
                        return;
                    }
                    if (data && data.status === "00") {
                        $('#modalDelete').modal('hide');
                        swal.fire('Success!', 'User has been deleted.', 'success');
                    } else {
                        $('#modalDelete').modal('hide');
                        swarning();
                    }
                    if (localStorage.getItem("lvlI") === "1") {
                        listReportsAdmin(localStorage.getItem("selKmj"),
                            localStorage.getItem("selScn"),
                            localStorage.getItem("selGng"));
                    } else if (["2", "3", "4", "5", "6"].includes(localStorage.getItem("lvlI"))) {
                        var scn = localStorage.getItem("scn");
                        localStorage.setItem("selScn", scn);
                        console.log(scn);

                        if (scn == 'null' || scn == ' ') {
                            $("#contentOthers").show();
                            $("#contentNormal").hide();
                            $("#contentAdmin").hide();
                        } else {
                            $("#contentNormal").show();
                            $("#contentOthers").hide();
                            $("#contentAdmin").hide();

                            listReportsNormal(localStorage.getItem("selScn"),
                                localStorage.getItem("selGng"));
                        }
                    }
                },
                error: function (xhr, status, error) {
                    console.error("Error Status:", status);
                    console.error("Error Thrown:", error);
                    console.error("Response Text:", xhr.responseText);
                    swarning();
                },
                complete: function () {
                    console.log("Request completed");
                }
            });
        }

        function listCuti() {
            $.ajax({
                url: linkDepan + "GetCutiList",
                dataType: "json",
                beforeSend: function (request) {
                    request.setRequestHeader("Token", localStorage.getItem('main'));
                },
                success: function (data) {
                    if (data.length >= 1) {
                        auxArr = [];
                        $.each(data, function (index, value) {
                            auxArr[index] = "<option value='" + value.cuti_code + "'>" + value.cuti_name + "</option>";
                        });
                        $('#cuti').append(auxArr.join(''));
                    } else {
                        $("#cuti").addClass(" is-invalid");

                    }
                },
                error: function (xhr) {
                    swarning();
                },
                complete: function () {
                }
            });
        }

        function listSection() {
            $.ajax({
                url: linkDepan + "GetSectionList",
                dataType: "json",
                beforeSend: function (request) {
                    request.setRequestHeader("Token", localStorage.getItem('main'));
                },
                success: function (data) {
                    if (data.length >= 1) {
                        auxArr = [];
                        $.each(data, function (index, value) {
                            auxArr[index] = "<option value='" + value.section_id + "'>" + value.section_name + "</option>";
                        });
                        $('#section').append(auxArr.join(''));
                    } else {
                        $("#section").addClass(" is-invalid");

                    }
                },
                error: function (xhr) {
                    swarning();
                },
                complete: function () {
                }
            });
        }

        function listKMUJ() {
            $.ajax({
                url: linkDepan + "KMUJList",
                dataType: "json",
                beforeSend: function (request) {
                    request.setRequestHeader("Token", localStorage.getItem('main'));
                },
                success: function (data) {
                    if (data.length >= 1) {
                        auxArr = [];
                        $.each(data, function (index, value) {
                            auxArr[index] = "<option value='" + value.kmuj_id + "'>" + value.kmuj_name + "</option>";
                        });
                        $('#kmuj').append(auxArr.join(''));
                    } else {
                        $("#kmuj").addClass(" is-invalid");

                    }
                },
                error: function (xhr) {
                    swarning();
                },
                complete: function () {
                }
            });
        }

        function listGang() {
            $.ajax({
                url: linkDepan + "GangList",
                dataType: "json",
                beforeSend: function (request) {
                    request.setRequestHeader("Token", localStorage.getItem('main'));
                },
                success: function (data) {
                    if (data.length >= 1) {
                        auxArr = [];
                        $.each(data, function (index, value) {
                            auxArr[index] = "<option value='" + value.id + "'>" + value.gang + "</option>";
                        });
                        $("#gangAdmin, #gangNormal").append(auxArr.join(''));
                    } else {
                        $("#gangAdmin, #gangNormal").addClass(" is-invalid");

                    }
                },
                error: function (xhr) {
                    swarning();
                },
                complete: function () {
                }
            });
        }

        function listUsrLevel() {
            $.ajax({
                url: linkDepan + "GetUserLevelList",
                dataType: "json",
                beforeSend: function (request) {
                    request.setRequestHeader("Token", localStorage.getItem('main'));
                },
                success: function (data) {
                    if (data.length >= 1) {
                        auxArr = [];
                        $.each(data, function (index, value) {
                            auxArr[index] = "<option value='" + value.ref_level_no + "'>" + value.ref_level_name + "</option>";
                        });
                        $('#userlevel, #userlevel2').append(auxArr.join(''));
                    } else {
                        $("#userlevel, #userlevel2").addClass(" is-invalid");

                    }
                },
                error: function (xhr) {
                    swarning();
                },
                complete: function () {
                }
            });
        }

        function listReportsAdmin(kmuj, section, gang) {
            $.ajax({
                url: linkDepan + "GetGListAdmin?Kmuj=" + kmuj + "&Section=" + section + "&Gang=" + gang,
                type: 'GET',
                dataType: 'json',
                data: {},
                beforeSend: function (request) {
                    request.setRequestHeader("Token", localStorage.getItem('main'));
                },
                success: function (data) {
                    var counter = 1, countStf = 0, countID = 0;
                    $.fn.dataTable.ext.errMode = 'throw';
                    if ($.fn.dataTable.isDataTable("#tableAdmin")) {
                        $("#tableAdmin").DataTable().destroy();
                    }
                    $("#tableAdmin").DataTable({
                        responsive: true,
                        data: data,
                        columns: [
                            { data: "no" },
                            { data: "Emplid" },
                            { data: "Nama" },
                            { data: "JobGrade" },
                            { data: "JobDesc" },
                            { data: "cuti_name" },
                            { data: "Emplid" },
                        ],
                        columnDefs: [{
                            targets: -1,
                            title: "Actions",
                            render: function (data, type, full, meta) {
                                countStf++;
                                /*return '<a href="..' + data + '" id="BviewRes" class="btn btn-primary"><i class="fe fe-edit font-16"></i>';*/
                                return '<a class="modal-effect btn btn-primary" data-id="' + data + '" data-bs-target="#modalDetails" data-bs-effect="effect-sign" data-bs-toggle="modal" ><i class="fe fe-edit font-10"></i></a>' + "   " + '<a class="btn btn-danger" data-id="' + data + '" data-bs-target="#modalDelete" data-bs-effect="effect-sign" data-bs-toggle="modal" ><i class="fe fe-trash font-10"></i></a>'

                            },
                        },
                        {
                            targets: -2,
                            title: "Status",
                            render: function (data, type, full, meta) {
                                var status = '';
                                if (data == 'VALID') { status = '<a class="text-success">' + data + ' <i class="ion-checkmark-circled"></i></a></p >'; }
                                else {
                                    status = '<a class="text-danger">' + data + ' <i class="ion-close-circled"></i></a></p >';
                                }
                                return status;
                            },
                        },
                        {
                            targets: -3,
                            title: "Position",
                            render: function (data, type, full, meta) {
                                return data;
                            },
                        },
                        {
                            targets: -4,
                            title: "Grade",
                            render: function (data, type, full, meta) {
                                return data;
                            },
                        },
                        {
                            targets: -5,
                            title: "Name",
                            render: function (data, type, full, meta) {
                                return data;
                            },
                        },
                        {
                            targets: -6,
                            title: "Staff ID",
                            render: function (data, type, full, meta) {
                                return data;
                            },
                        },
                        {
                            targets: -7,
                            title: "No",
                            render: function (data, type, full, meta) {
                                return counter++;
                            },
                        },
                        ],
                        createdRow: function (row, data, dataIndex) {
                            $('td', row).addClass('text-nowrap align-middle');
                        }
                    });
                },
                error: function (xhr) {
                    swarning();
                },
                complete: function () {
                }

            });
        }

        function listReportsNormal(section, gang) {
            $.ajax({
                url: linkDepan + "GetGListNormal?Section=" + section + "&Gang=" + gang,
                type: 'GET',
                dataType: 'json',
                data: {},
                beforeSend: function (request) {
                    request.setRequestHeader("Token", localStorage.getItem('main'));
                },
                success: function (data) {
                    var counter = 1, countStf = 0, countID = 0;
                    $.fn.dataTable.ext.errMode = 'throw';
                    if ($.fn.dataTable.isDataTable("#tableNormal")) {
                        $("#tableNormal").DataTable().destroy();
                    }
                    $("#tableNormal").DataTable({
                        responsive: true,
                        data: data,
                        columns: [
                            { data: "no" },
                            { data: "Emplid" },
                            { data: "Nama" },
                            { data: "JobGrade" },
                            { data: "JobDesc" },
                            { data: "cuti_name" },
                            { data: "Emplid" },
                        ],
                        columnDefs: [{
                            targets: -1,
                            title: "Actions",
                            render: function (data, type, full, meta) {
                                countStf++;
                                /*return '<a href="..' + data + '" id="BviewRes" class="btn btn-primary"><i class="fe fe-edit font-16"></i>';*/
                                return '<a class="modal-effect btn btn-primary" data-id="' + data + '" data-bs-target="#modalDetails" data-bs-effect="effect-sign" data-bs-toggle="modal" ><i class="fe fe-edit font-10"></i></a>' + "   " + '<a class="btn btn-danger" data-id="' + data + '" data-bs-target="#modalDelete" data-bs-effect="effect-sign" data-bs-toggle="modal" ><i class="fe fe-trash font-10"></i></a>'
                            },
                        },
                        {
                            targets: -2,
                            title: "Status",
                            render: function (data, type, full, meta) {
                                var status = '';
                                if (data == 'VALID') { status = '<a class="text-success">' + data + ' <i class="ion-checkmark-circled"></i></a></p >'; }
                                else {
                                    status = '<a class="text-danger">' + data + ' <i class="ion-close-circled"></i></a></p >';
                                }
                                return status;
                            },
                        },
                        {
                            targets: -3,
                            title: "Position",
                            render: function (data, type, full, meta) {
                                return data;
                            },
                        },
                        {
                            targets: -4,
                            title: "Grade",
                            render: function (data, type, full, meta) {
                                return data;
                            },
                        },
                        {
                            targets: -5,
                            title: "Name",
                            render: function (data, type, full, meta) {
                                return data;
                            },
                        },
                        {
                            targets: -6,
                            title: "Staff ID",
                            render: function (data, type, full, meta) {
                                return data;
                            },
                        },
                        {
                            targets: -7,
                            title: "No",
                            render: function (data, type, full, meta) {
                                return counter++;
                            },
                        },
                        ],
                        createdRow: function (row, data, dataIndex) {
                            $('td', row).addClass('text-nowrap align-middle');
                        }
                    });
                },
                error: function (xhr) {
                    swarning();
                },
                complete: function () {
                }

            });
        }

    </script>
}


